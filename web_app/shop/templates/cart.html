{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta content="width=device-width,initial-scale=1" name="viewport">
    <title>Teluxe - Luxury Watch Collection | Premium Timepieces</title>
    <meta content="Discover the finest luxury timepieces from Rolex, Omega, Patek Philippe & more. Premium watches with authenticated quality and exclusive designs." name="description">
    <meta content="luxury watches, premium timepieces, Rolex, Omega, Patek Philippe, Audemars Piguet, luxury accessories" name="keywords">
    <meta content="Teluxe" name="author">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <meta content="Teluxe - Luxury Watch Collection" property="og:title">
    <meta content="Discover the finest luxury timepieces from the world's most prestigious brands" property="og:description">
    <meta content="website" property="og:type">
    <meta content="https://lovable.dev/opengraph-image-p98pqg.png" property="og:image">
    <meta content="summary_large_image" name="twitter:card">
    <meta content="@lovable_dev" name="twitter:site">
    <meta content="https://lovable.dev/opengraph-image-p98pqg.png" name="twitter:image">
  <script type="text/javascript" src="{% static 'script.js' %}"></script>
  <script type="text/javascript" src="{% static 'cart.js' %}"></script>

  <link href="{% static 'index.css' %}" rel="stylesheet">
  <link href="{% static 'sonner-toaster.css' %}" rel="stylesheet">
  </head>
  <body>
    {% csrf_token %}
    <div id="root">
      <div aria-label="Notifications (F8)" role="region" style="pointer-events:none" tabindex="-1">
        <ol class="fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]" tabindex="-1"></ol>
      </div>
      <section aria-atomic="false" aria-label="Notifications alt+T" aria-live="polite" aria-relevant="additions text" tabindex="-1"></section>
      <div class="min-h-screen bg-background font-luxury">
        <main class="pb-16">
          <div class="p-4">
            <h1 class="text-3xl font-bold text-luxury-black mb-8">Shopping Cart</h1>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
              <!-- Cart Items -->
              <div class="lg:col-span-2">
                <div class="cart-items-container">
                  <!-- Cart items will be rendered here by JavaScript -->
                  <div class="text-center py-8">
                    <div class="animate-pulse">
                      <div class="text-luxury-gray-dark">Loading cart...</div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Cart Summary -->
              <div class="lg:col-span-1">
                <div class="cart-summary" style="display: none;">
                  <!-- Summary will be rendered here by JavaScript -->
                </div>
              </div>
            </div>
          </div>
            </div>
          </div>
        </main>
        {% with active_page='cart' %}
          {% include 'navbar.html' %}
        {% endwith %}
      </div>
    </div>
    
    <script>
      // Initialize the cart system when page loads
      document.addEventListener('DOMContentLoaded', function() {
        window.cartManager = new ServerCartManager();
        loadCartPage();
      });

      async function loadCartPage() {
        try {
          const cartData = await window.cartManager.loadCart();
          renderCartItems(cartData.items);
          renderCartSummary(cartData);
        } catch (error) {
          console.error('Error loading cart:', error);
          const container = document.querySelector('.cart-items-container');
          container.innerHTML = `
            <div class="text-center py-8">
              <div class="text-red-500 mb-2">Error loading cart</div>
              <button onclick="location.reload()" class="bg-luxury-gold hover:bg-luxury-gold-dark text-luxury-black px-4 py-2 rounded">
                Retry
              </button>
            </div>
          `;
        }
      }

      function renderCartItems(items) {
        const container = document.querySelector('.cart-items-container');
        
        if (!items || items.length === 0) {
          container.innerHTML = `
            <div class="flex flex-col items-center justify-center py-12 px-4">
              <div class="text-center max-w-sm">
                <svg class="lucide lucide-shopping-bag mx-auto text-luxury-gray mb-4" fill="none" height="64" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="64" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path>
                  <path d="M3 6h18"></path>
                  <path d="M16 10a4 4 0 0 1-8 0"></path>
                </svg>
                <h2 class="text-xl font-bold text-luxury-black mb-2">Your Cart is Empty</h2>
                <p class="text-luxury-gray-dark mb-6">
                  Discover our luxury timepieces and find your perfect watch.
                </p>
                
                <div class="space-y-3">
                  <a href="{% url 'shop:catalog' %}" 
                     class="inline-flex items-center px-6 py-2.5 bg-luxury-gold hover:bg-luxury-gold-dark text-luxury-black font-semibold rounded-lg transition-all duration-200 shadow-md hover:shadow-lg">
                    Browse Collection
                  </a>
                  
                  <div>
                    <a href="{% url 'shop:index' %}" 
                       class="inline-flex items-center px-4 py-2 text-luxury-gray-dark hover:text-luxury-gold transition-colors duration-200 text-sm">
                      Back to Home
                    </a>
                  </div>
                </div>
              </div>
            </div>
          `;
          document.querySelector('.cart-summary').style.display = 'none';
          return;
        }

        const itemsHtml = items.map(item => {
          const customizationHtml = item.customization_data ? 
            Object.entries(JSON.parse(item.customization_data))
              .map(([key, value]) => `<span class="text-sm text-luxury-gray-dark">${key}: ${value}</span>`)
              .join('<br>') : '';

          return `
            <div class="cart-item bg-luxury-white rounded-lg shadow-sm p-4 mb-4" data-item-id="${item.id}">
              <div class="flex items-center space-x-4">
                <img src="${item.product.image_url || '{% static "hero-watch-D40AmJ87.jpg" %}'}" 
                     alt="${item.product.name}" 
                     class="w-16 h-16 object-cover rounded">
                <div class="flex-1">
                  <h3 class="font-semibold text-luxury-black">${item.product.name}</h3>
                  <div class="text-luxury-gray-dark">${customizationHtml}</div>
                  <div class="text-lg font-bold text-luxury-gold">$${item.price}</div>
                </div>
                <div class="flex items-center space-x-2">
                  <button onclick="updateItemQuantity(${item.id}, ${item.quantity - 1})" 
                          class="w-8 h-8 bg-luxury-gray-light hover:bg-luxury-gray rounded text-luxury-black">-</button>
                  <span class="w-12 text-center">${item.quantity}</span>
                  <button onclick="updateItemQuantity(${item.id}, ${item.quantity + 1})" 
                          class="w-8 h-8 bg-luxury-gray-light hover:bg-luxury-gray rounded text-luxury-black">+</button>
                  <button onclick="removeItem(${item.id})" 
                          class="ml-2 text-red-500 hover:text-red-700">
                    Ã—
                  </button>
                </div>
              </div>
            </div>
          `;
        }).join('');

        container.innerHTML = itemsHtml;
        document.querySelector('.cart-summary').style.display = 'block';
      }

      function renderCartSummary(cartData) {
        const summaryContainer = document.querySelector('.cart-summary');
        const orderConfirmationUrl = "{% url 'shop:order_confirmation' %}";
        
        summaryContainer.innerHTML = `
          <div class="bg-luxury-white p-6 rounded-lg shadow-sm">
            <h2 class="text-xl font-bold text-luxury-black mb-4">Order Summary</h2>
            <div class="space-y-2 mb-4">
              <div class="flex justify-between">
                <span>Items (${cartData.total_items}):</span>
                <span>$${cartData.total_price}</span>
              </div>
              <div class="flex justify-between font-bold text-lg border-t pt-2">
                <span>Total:</span>
                <span class="text-luxury-gold">$${cartData.total_price}</span>
              </div>
            </div>
            <button onclick="clearCart()" 
                    class="w-full mb-2 bg-luxury-gray-light hover:bg-luxury-gray text-luxury-black font-semibold py-2 px-4 rounded">
              Clear Cart
            </button>
            <button onclick="placeOrder()" 
                    class="w-full bg-luxury-gold hover:bg-luxury-gold-dark text-luxury-black font-semibold py-2 px-4 rounded">
              Place Order
            </button>
          </div>
        `;
      }

      async function updateItemQuantity(itemId, newQuantity) {
        if (newQuantity <= 0) {
          removeItem(itemId);
          return;
        }

        try {
          await window.cartManager.updateQuantity(itemId, newQuantity);
          loadCartPage(); // Reload to show updated data
        } catch (error) {
          console.error('Error updating quantity:', error);
          showToast('Error updating quantity', 'error');
        }
      }

      async function removeItem(itemId) {
        try {
          await window.cartManager.removeFromCart(itemId);
          loadCartPage(); // Reload to show updated data
        } catch (error) {
          console.error('Error removing item:', error);
          showToast('Error removing item', 'error');
        }
      }

      async function clearCart() {
        if (confirm('Are you sure you want to clear your cart?')) {
          try {
            await window.cartManager.clearCart();
            loadCartPage(); // Reload to show empty cart
          } catch (error) {
            console.error('Error clearing cart:', error);
            showToast('Error clearing cart', 'error');
          }
        }
      }

      async function placeOrder() {
        try {
          // Get CSRF token
          const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                           document.querySelector('meta[name=csrf-token]')?.content ||
                           getCookie('csrftoken') || '';
          
          // Create order from cart items
          const response = await fetch('/api/create-order/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken
            }
          });
          
          const data = await response.json();
          
          if (data.success) {
            // Show success message
            showToast(`Order ${data.order_number} placed successfully!`, 'success');
            
            // Redirect to order confirmation page
            window.location.href = "{% url 'shop:order_confirmation' %}";
          } else {
            showToast(data.error || 'Failed to place order', 'error');
          }
        } catch (error) {
          console.error('Error placing order:', error);
          showToast('Error placing order', 'error');
        }
      }
      
      // Helper function to get cookie value
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
    </script>
  </body>
</html>