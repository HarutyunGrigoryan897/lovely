{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta content="width=device-width,initial-scale=1" name="viewport">
    <title>Teluxe - Luxury Watch Collection | Premium Timepieces</title>
    <meta content="Discover the finest luxury timepieces from Rolex, Omega, Patek Philippe & more. Premium watches with authenticated quality and exclusive designs." name="description">
    <meta content="luxury watches, premium timepieces, Rolex, Omega, Patek Philippe, Audemars Piguet, luxury accessories" name="keywords">
    <meta content="Teluxe" name="author">
    <meta content="Teluxe - Luxury Watch Collection" property="og:title">
    <meta content="Discover the finest luxury timepieces from the world's most prestigious brands" property="og:description">
    <meta content="website" property="og:type">
    <meta content="https://lovable.dev/opengraph-image-p98pqg.png" property="og:image">
    <meta content="summary_large_image" name="twitter:card">
    <meta content="@lovable_dev" name="twitter:site">
    <meta content="https://lovable.dev/opengraph-image-p98pqg.png" name="twitter:image">
    <script type="text/javascript" src="{% static 'script.js' %}"></script>
    <script type="text/javascript" src="{% static 'cart.js' %}"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <link href="{% static 'index.css' %}" rel="stylesheet">
    <link href="{% static 'sonner-toaster.css' %}" rel="stylesheet">
  </head>
  <body>
    <div id="root">
      <div aria-label="Notifications (F8)" role="region" style="pointer-events:none" tabindex="-1">
        <ol class="fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]" tabindex="-1"></ol>
      </div>
      <section aria-atomic="false" aria-label="Notifications alt+T" aria-live="polite" aria-relevant="additions text" tabindex="-1"></section>
      <div class="min-h-screen bg-background font-luxury">
        <main class="pb-16">
          <div class="p-4 space-y-6">
            <div class="rounded-lg border bg-card text-card-foreground shadow-sm p-6">
              <div class="flex items-center gap-4 mb-4">
                <span class="relative flex shrink-0 overflow-hidden rounded-full w-16 h-16">
                  <span id="user-avatar" class="flex h-full w-full items-center justify-center rounded-full bg-luxury-gold text-luxury-black text-xl font-bold">?</span>
                </span>
                <div class="flex-1">
                  <h2 id="user-name" class="text-xl font-bold text-luxury-black">Loading...</h2>
                  <p id="user-username" class="text-luxury-gray-dark">@loading</p>
                  <div id="user-badge" class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent hover:bg-primary/80 mt-1 bg-luxury-gold text-luxury-black">Member</div>
                </div>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 pt-4 border-t border-luxury-gray">
                <div class="text-center">
                  <p class="text-2xl font-bold text-luxury-black orders-count">{{ orders_count|default:0 }}</p>
                  <p class="text-sm text-luxury-gray-dark">Orders</p>
                </div>
                <div class="text-center">
                  <p class="text-lg sm:text-xl lg:text-2xl font-bold text-luxury-black total-spent break-all" title="Total confirmed spending: ${{ total_spent|floatformat:2|default:'0.00' }}{% if total_order_value != total_spent %} | Total order value: ${{ total_order_value|floatformat:2|default:'0.00' }}{% endif %}">${{ total_spent|floatformat:2|default:"0.00" }}</p>
                  <p class="text-sm text-luxury-gray-dark">Total Spent{% if total_spent > 0 %} âœ“{% endif %}</p>
                  {% if total_order_value != total_spent and total_order_value > 0 %}
                  <p class="text-xs text-luxury-gray opacity-75 break-all">(${{ total_order_value|floatformat:2 }} in all orders)</p>
                  {% endif %}
                </div>
                <div class="text-center">
                  <div class="flex flex-col sm:flex-row items-center justify-center mb-1">
                    <svg class="lucide lucide-clock text-luxury-gold mr-0 sm:mr-1 mb-1 sm:mb-0" fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12" cy="12" r="10"></circle>
                      <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <span class="text-sm text-luxury-gray-dark text-center">
                      {% if member_since %}
                        {{ member_since|date:"M Y" }}
                      {% else %}
                        Not registered
                      {% endif %}
                    </span>
                  </div>
                  <p class="text-sm text-luxury-gray-dark">Member Since</p>
                </div>
              </div>
            </div>
            <div class="space-y-3">
              <div class="rounded-lg border bg-card text-card-foreground shadow-sm p-4 cursor-pointer hover:shadow-card transition-all duration-300" onclick="window.location.href='{% url 'shop:orders' %}'">
                <div class="flex items-center gap-4">
                  <div class="p-2 bg-luxury-gold/10 rounded-lg">
                    <svg class="lucide lucide-package text-luxury-gold" fill="none" height="20" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg">
                      <path d="M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z"></path>
                      <path d="M12 22V12"></path>
                      <path d="m3.3 7 7.703 4.734a2 2 0 0 0 1.994 0L20.7 7"></path>
                      <path d="m7.5 4.27 9 5.15"></path>
                    </svg>
                  </div>
                  <div class="flex-1">
                    <h3 class="font-semibold text-luxury-black">Order History</h3>
                    <p class="text-sm text-luxury-gray-dark">View all your orders</p>
                  </div>
                  <svg class="lucide lucide-chevron-right text-luxury-gray-dark" fill="none" height="20" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="m9 18 6-6-6-6"></path>
                  </svg>
                </div>
              </div>
              <div class="rounded-lg border bg-card text-card-foreground shadow-sm p-4 cursor-pointer hover:shadow-card transition-all duration-300" onclick="window.location.href='{% url 'shop:favorites' %}'">
                <div class="flex items-center gap-4">
                  <div class="p-2 bg-luxury-gold/10 rounded-lg">
                    <svg class="lucide lucide-heart text-luxury-gold" fill="none" height="20" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg">
                      <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path>
                    </svg>
                  </div>
                  <div class="flex-1">
                    <h3 class="font-semibold text-luxury-black">Favorites</h3>
                    <p class="text-sm text-luxury-gray-dark">Your saved timepieces</p>
                  </div>
                  <svg class="lucide lucide-chevron-right text-luxury-gray-dark" fill="none" height="20" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="m9 18 6-6-6-6"></path>
                  </svg>
                </div>
              </div>
            </div>
            <div>
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-luxury-black">Recent Orders</h3>
                <button class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:bg-accent h-10 px-4 py-2 text-luxury-gold hover:text-luxury-gold-dark" onclick="window.location.href='{% url 'shop:orders' %}'"View All <svg class="lucide lucide-chevron-right ml-1 h-4 w-4" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
                    <path d="m9 18 6-6-6-6"></path>
                  </svg>
                </button>
              </div>
              <div class="space-y-3" id="account-recent-orders">
                {% if recent_orders %}
                  {% for order in recent_orders %}
                  <div class="bg-luxury-white rounded-lg border border-luxury-gray p-4">
                    <div class="flex justify-between items-start mb-2">
                      <div>
                        <p class="font-semibold text-luxury-black">Order #{{ order.order_number }}</p>
                        <p class="text-sm text-luxury-gray-dark">{{ order.created_at|date:"M j, Y" }}</p>
                      </div>
                      <div class="text-right">
                        <p class="font-bold text-luxury-gold">${{ order.total_amount }}</p>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium 
                          {% if order.status == 'pending' %}bg-yellow-100 text-yellow-800
                          {% elif order.status == 'confirmed' %}bg-blue-100 text-blue-800
                          {% elif order.status == 'processing' %}bg-purple-100 text-purple-800
                          {% elif order.status == 'shipped' %}bg-indigo-100 text-indigo-800
                          {% elif order.status == 'delivered' %}bg-green-100 text-green-800
                          {% elif order.status == 'cancelled' %}bg-red-100 text-red-800
                          {% endif %}">
                          {{ order.get_status_display }}
                        </span>
                      </div>
                    </div>
                    <div class="text-sm text-luxury-gray-dark">
                      {{ order.total_items }} item{{ order.total_items|pluralize }}
                      {% if order.items.all %}
                        - {{ order.items.all.0.product.name }}
                        {% if order.total_items > 1 %}
                          and {{ order.total_items|add:"-1" }} more
                        {% endif %}
                      {% endif %}
                    </div>
                  </div>
                  {% endfor %}
                {% else %}
                  <div class="text-center py-8">
                    <svg class="lucide lucide-package mx-auto text-luxury-gray mb-3" fill="none" height="48" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="48" xmlns="http://www.w3.org/2000/svg">
                      <path d="M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z"></path>
                      <path d="M12 22V12"></path>
                      <path d="m3.3 7 7.703 4.734a2 2 0 0 0 1.994 0L20.7 7"></path>
                      <path d="m7.5 4.27 9 5.15"></path>
                    </svg>
                    <p class="text-luxury-gray-dark mb-2">No orders yet</p>
                    <a href="{% url 'shop:catalog' %}" class="text-luxury-gold hover:text-luxury-gold-dark text-sm font-medium">Start shopping</a>
                  </div>
                {% endif %}
              </div>
            </div>
            <div>
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-luxury-black">Favorites</h3>
                <button class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:bg-accent h-10 px-4 py-2 text-luxury-gold hover:text-luxury-gold-dark" onclick="window.location.href='{% url 'shop:favorites' %}'"View All <svg class="lucide lucide-chevron-right ml-1 h-4 w-4" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
                    <path d="m9 18 6-6-6-6"></path>
                  </svg>
                </button>
              </div>
              <div id="account-favorites-preview" class="grid grid-cols-1 gap-3">
                <!-- Favorites preview will be populated here -->
              </div>
            </div>
          </div>
        </main>
        {% with active_page='account' %}
          {% include 'navbar.html' %}
        {% endwith %}
      </div>
    </div>
    
    <script>
      // Account page specific JavaScript
      document.addEventListener('DOMContentLoaded', function() {
        // Initialize favorites manager - this will show empty state if no favorites
        FavoritesManager.loadFavorites();
        
        // Listen for authentication status changes
        window.addEventListener('authStatusChanged', function(event) {
          const { isAuthenticated, user, isTelegramUser } = event.detail;
          updateAccountInfo(isAuthenticated, user, isTelegramUser);
        });
        
        // Also check immediately if auth is already available
        if (window.telegramAuth && window.telegramAuth.isAuthenticated) {
          updateAccountInfo(
            window.telegramAuth.isAuthenticated,
            window.telegramAuth.user,
            window.telegramAuth.isTelegramUser
          );
        }
      });
      
      function updateAccountInfo(isAuthenticated, user, isTelegramUser) {
        if (!isAuthenticated || !user) {
          // Show login prompt or redirect
          document.getElementById('user-name').textContent = 'Guest User';
          document.getElementById('user-username').textContent = '@guest';
          document.getElementById('user-avatar').textContent = '?';
          document.getElementById('user-badge').textContent = 'Not Logged In';
          
          // Reset statistics for non-authenticated users
          document.querySelector('.orders-count').textContent = '0';
          document.querySelector('.total-spent').textContent = '$0.00';
          document.querySelector('.text-luxury-gray-dark').textContent = 'Not registered';
          return;
        }
        
        // Update user display
        const firstName = user.first_name || '';
        const lastName = user.last_name || '';
        const fullName = (firstName + ' ' + lastName).trim() || user.username;
        
        document.getElementById('user-name').textContent = fullName;
        document.getElementById('user-username').textContent = '@' + (user.username || user.id);
        
        // Update avatar with initials
        const initials = getInitials(fullName || user.username);
        document.getElementById('user-avatar').textContent = initials;
        
        // Update badge based on user type
        const badge = document.getElementById('user-badge');
        if (isTelegramUser) {
          badge.textContent = 'Telegram User';
          badge.className = badge.className.replace('bg-luxury-gold', 'bg-blue-500 text-white');
        } else {
          badge.textContent = 'Web User';
          badge.className = badge.className.replace('bg-luxury-gold', 'bg-green-500 text-white');
        }
        
        // Note: Statistics (orders count, total spent, member since) are rendered server-side
        // and don't need to be updated here as they come from the database
      }
      
      function getInitials(name) {
        return name
          .split(' ')
          .map(word => word[0])
          .join('')
          .toUpperCase()
          .substring(0, 2) || '?';
      }
    </script>
  </body>
</html>